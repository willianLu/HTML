<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <title>Promise 函数</title>
    </head>
    <body>
        <script>
            // 延迟函数
            function delay(duration = 1000, value) {
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve(value);
                    }, duration)
                })
            }
            // promise的reduce方法
            function pReduce(iterable, reducer, initialValue) {
                return new Promise((resolve, reject) => {
                    const iterator = iterable[Symbol.iterator]();
                    let index = 0;
                    const next = async (total) => {
                        const element = iterator.next(); // 获取下一项
                        if(element.done) {
                            resolve(total);
                            return;
                        }
                        console.log(iterable, element, "-----------------kkk")
                        try {
                            const [resolvedTotal, resolvedValue] = await Promise.all([total, element.value]);
                            // 迭代下一项
                            console.log(resolvedTotal, resolvedValue, '----------------------测试')
                            next(reducer(resolvedTotal, resolvedValue, index++));
                        } catch (error) {
                            reject(error);
                        }
                    }
                    next(initialValue);
                })
            }
            // promise.all实现
            function pAll(iterators) {
                return new Promise((resolve, reject) => {
                    if(!iterators || iterators.length === 0) {
                        return resolve([]);
                    }
                    let count = 0;
                    const data = []
                    for(let i = 0; i < iterators.length; i++) {
                        Promise.resolve(iterators[i]).then((res) => {
                            data[i] = res;
                            if(++count === iterators.length) {
                                resolve(data);
                            }
                        }).catch(error => {
                            reject(error)
                        })
                    }
                })
            }
            // promise的map方法
            function pMap(iterable, mapper, options = {}) {
                return new Promise((resolve, reject) => {
                    if(!Array.isArray(iterable) || iterable.length === 0) {
                        return [];
                    }
                    const iterator = iterable[Symbol.iterator]();
                    const result = [];
                    let count = 0;
                    const next = async(i) => {
                        const element = iterator.next(); // 获取下一项
                        if(element.done) {
                            return resolve(result);
                        }
                        try {
                            const res = await element.value;
                            result.push(mapper(res));
                            console.log(res, "-----------------结果")
                        } catch (error) {
                            console.log(error, "-----------------错误")
                            return reject(error);
                        }
                        if(++count === iterable.length) {
                            next();
                        }
                    }
                    for(let i = 0; i < iterable.length; i++) {
                        next(i)
                    }
                })
            }
            function p1(duration = 200) {
                return new Promise((resolve, reject) => {
                    setTimeout(() => {
                        reject('错误')
                    }, duration)
                })
            }

            async function test() {
                console.time("test");
                // const res = await pReduce([delay(800, 1), 2, delay(1000, 3)], (a,b) => {
                //     return a + b;
                // }, 0);
                // console.log(res, "----------------------结果")
                console.log('-------------开始')
                try {
                    const res = await pMap([delay(800, 1), 2, delay(1000, 3), p1()], (item) => item * 10);
                    console.log(res, "----------------------结束结果")
                } catch (error) {
                    console.log(error, '-------------捕获错误')
                }
                console.timeEnd("test");
                
            }
            test();
            let arr = [1,2,3,4];
            let data = [
                {
                    type: 1
                },
                {
                    type: 3
                }
            ]
        </script>
    </body>
</html>
